name: Services Deploy (Reusable)

on:
  workflow_call:
    inputs:
      environment:
        required: true
        type: string
      aws_account_id:
        required: true
        type: string
      lambda_functions:
        required: false
        type: string
        description: 'JSON array of Lambda functions to deploy, e.g. [{"name": "db-migration-runner", "directory": "lambda", "runtime": "nodejs"}]'
        default: "[]"

permissions:
  id-token: write
  contents: read

jobs:
  deploy-lambda-functions:
    name: Deploy Lambda Functions to ${{ inputs.environment }}
    runs-on: ubuntu-latest
    env:
      AWS_REGION: "eu-west-2"
    strategy:
      fail-fast: false
      matrix:
        function: ${{ fromJSON(inputs.lambda_functions) }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v3
        with:
          role-to-assume: arn:aws:iam::${{ inputs.aws_account_id }}:role/GithubActionsLambdaDeployRole
          role-session-name: GitHubLambdaDeploySession
          aws-region: ${{ env.AWS_REGION}}

      # Node.js Lambda Steps
      - name: Install Node.js
        if: matrix.function.runtime == 'nodejs'
        uses: actions/setup-node@v3
        with:
          node-version: "18"

      - name: Generate package.json for Node.js Lambda - ${{ matrix.function.name }}
        if: matrix.function.runtime == 'nodejs'
        run: |
          cd ${{ matrix.function.directory }}
          # Create package.json with required dependencies
          cat > package.json << EOF
          {
            "name": "${{ matrix.function.name }}",
            "version": "1.0.0",
            "description": "Lambda function for ${{ matrix.function.name }}",
            "main": "index.js",
            "dependencies": {
              "aws-sdk": "^2.1531.0",
              "pg": "^8.11.3"
            },
            "engines": {
              "node": ">=18.x"
            },
            "scripts": {
              "test": "echo \"Error: no test specified\" && exit 1"
            },
            "author": "",
            "license": "ISC"
          }
          EOF
          echo "Generated package.json:"
          cat package.json

      - name: Build Node.js Lambda package - ${{ matrix.function.name }}
        if: matrix.function.runtime == 'nodejs'
        run: |
          cd ${{ matrix.function.directory }}
          # Clean any existing node_modules and package-lock.json
          rm -rf node_modules package-lock.json

          # Install dependencies
          npm install --production

          # Create a clean package directory
          mkdir -p ./package

          # Copy only necessary files
          cp index.js ./package/
          cp -r node_modules ./package/
          if [ -d "src" ]; then
            cp -r src ./package/
          fi
          if [ -d "utils" ]; then
            cp -r utils ./package/
          fi

          # Create zip from package directory
          cd ./package
          zip -r ../${{ matrix.function.name }}.zip .
          cd ..

          # Clean up
          rm -rf ./package

          # Debug info
          echo "Created zip file at: ${{ matrix.function.directory }}/${{ matrix.function.name }}.zip"
          ls -la ${{ matrix.function.name }}.zip

      # Python Lambda Steps
      - name: Install Python
        if: matrix.function.runtime == 'python'
        uses: actions/setup-python@v4
        with:
          python-version: "3.9"

      - name: Create fixed requirements file for Python Lambda - ${{ matrix.function.name }}
        if: matrix.function.runtime == 'python'
        run: |
          cd ${{ matrix.function.directory }}
          if [ -f "requirements.txt" ]; then
            # Fix dependency conflicts by updating version constraints
            cat requirements.txt | sed 's/langchain-core==0.1.27/langchain-core>=0.1.33,<0.2.0/' > requirements-fixed.txt
            echo "Created fixed requirements file:"
            cat requirements-fixed.txt
          else
            echo "No requirements.txt found, creating empty requirements-fixed.txt"
            touch requirements-fixed.txt
          fi

      - name: Build Python Lambda package - ${{ matrix.function.name }}
        if: matrix.function.runtime == 'python'
        run: |
          cd ${{ matrix.function.directory }}
          # Create a package directory for Python dependencies
          mkdir -p ./package
          # Install dependencies from fixed requirements file
          pip install -r requirements-fixed.txt -t ./package
          # Copy Lambda function code
          cp lambda_function.py ./package/
          # Copy additional Python files if they exist
          if [ -d "agent" ]; then
            mkdir -p ./package/agent
            cp -r agent/* ./package/agent/
          fi
          # Create the zip package from the package directory
          cd ./package
          zip -r ../${{ matrix.function.name }}.zip .
          cd ..

          # Debug info
          echo "Created zip file at: ${{ matrix.function.directory }}/${{ matrix.function.name }}.zip"
          ls -la ${{ matrix.function.name }}.zip

      # Common upload step for both runtimes
      - name: Upload Lambda package to S3 - ${{ matrix.function.name }}
        run: |
          # Verify zip file exists before attempting upload
          if [ -f "${{ matrix.function.directory }}/${{ matrix.function.name }}.zip" ]; then
            echo "Uploading from ${{ matrix.function.directory }}/${{ matrix.function.name }}.zip"
            # Upload the zip directly from the function directory
            aws s3 cp ${{ matrix.function.directory }}/${{ matrix.function.name }}.zip s3://lambda-deployments-${{ inputs.aws_account_id }}/functions/${{ matrix.function.name }}.zip
          else
            echo "ERROR: ZIP file not found at ${{ matrix.function.directory }}/${{ matrix.function.name }}.zip"
            ls -la ${{ matrix.function.directory }}/
            exit 1
          fi

      - name: Update Lambda code from S3 - ${{ matrix.function.name }}
        run: |
          aws lambda update-function-code \
            --function-name ${{ matrix.function.name }} \
            --s3-bucket lambda-deployments-${{ inputs.aws_account_id }} \
            --s3-key functions/${{ matrix.function.name }}.zip
